(()=>{"use strict";class e{constructor(e,t){this.width=e,this.height=t,this.grid=Array(t).fill(null).map(()=>Array(e).fill(null))}checkCollision(e,t,i){const r=e.getShape();for(let e=0;e<r.length;e++)for(let n=0;n<r[e].length;n++)if(0!==r[e][n]){const r=t+n,s=i+e;if(r<0||r>=this.width||s>=this.height)return!0;if(s>=0&&null!==this.grid[s][r])return!0}return!1}placeTetromino(e){const t=e.getShape();for(let i=0;i<t.length;i++)for(let r=0;r<t[i].length;r++)0!==t[i][r]&&(this.grid[e.y+i][e.x+r]=e.getSkinColor())}clear(){this.grid=Array(this.height).fill(null).map(()=>Array(this.width).fill(null))}clearLines(){let e=0;for(let t=this.height-1;t>=0;t--)this.grid[t].every(e=>null!==e)&&(this.grid.splice(t,1),this.grid.unshift(Array(this.width).fill(null)),e++,t++);return e}}const t="highScore",i=["I","J","L","O","S","T","Z"],r={I:"cyan",J:"blue",L:"orange",O:"yellow",S:"lime",T:"purple",Z:"red"},n={I:"#808080",J:"#808080",L:"#808080",O:"#808080",S:"#808080",T:"#808080",Z:"#808080"},s={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],J:[[1,0,0],[1,1,1],[0,0,0]],L:[[0,0,1],[1,1,1],[0,0,0]],O:[[1,1],[1,1]],S:[[0,1,1],[1,1,0],[0,0,0]],T:[[0,1,0],[1,1,1],[0,0,0]],Z:[[1,1,0],[0,1,1],[0,0,0]]};class o{constructor(e,t,i,r){this.x=e,this.y=t,this.type=i,this.shape=s[i]||[],this.skin=r}getInitialShape(e){return[]}getSkinColor(){return this.skin[this.type]||"gray"}move(e,t){this.x+=e,this.y+=t}rotate(){if("I"===this.type)4===this.shape.length&&1===this.shape[1][0]?this.shape=[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]:this.shape=[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]];else{const e=this.shape.length,t=Array.from({length:e},()=>Array(e).fill(0));for(let i=0;i<e;i++)for(let r=0;r<e;r++)t[r][e-1-i]=this.shape[i][r];this.shape=t}}getShape(){return this.shape}setShape(e){this.shape=e}getType(){return this.type}}class h{static saveItem(e,t){try{localStorage.setItem(e,t)}catch(e){console.error("Error saving to localStorage",e)}}static loadItem(e){try{return localStorage.getItem(e)}catch(e){return console.error("Error loading from localStorage",e),null}}static clearItem(e){try{localStorage.removeItem(e)}catch(e){console.error("Error clearing from localStorage",e)}}}const a=new class{constructor(t,i,n,s){this.currentTetromino=null,this.nextTetrominos=[],this.holdTetromino=null,this.canHold=!0,this.score=0,this.highScore=0,this.level=1,this.gameOver=!1,this.onLineClearCallback=null,this.onLevelUpCallback=null,this.currentSkin=r,this.board=new e(t,i),n&&(this.onLineClearCallback=n),s&&(this.onLevelUpCallback=s)}setTetrominoSkin(e){switch(e){case"default":this.currentSkin=r;break;case"grayscale":this.currentSkin=n;break;default:this.currentSkin=i.reduce((t,i)=>({...t,[i]:e}),{})}this.currentTetromino&&(this.currentTetromino=new o(this.currentTetromino.x,this.currentTetromino.y,this.currentTetromino.getType(),this.currentSkin)),this.nextTetrominos=this.nextTetrominos.map(e=>new o(e.x,e.y,e.getType(),this.currentSkin)),this.holdTetromino&&(this.holdTetromino=new o(this.holdTetromino.x,this.holdTetromino.y,this.holdTetromino.getType(),this.currentSkin))}start(){this.gameOver=!1,this.score=0,this.level=1,this.highScore=parseInt(h.loadItem(t)||"0"),this.board.clear(),this.holdTetromino=null,this.canHold=!0,this.nextTetrominos=[];for(let e=0;e<3;e++)this.nextTetrominos.push(this.generateRandomTetromino());this.spawnTetromino()}update(){if(!this.gameOver&&this.currentTetromino){const e=this.currentTetromino.y+1;if(this.board.checkCollision(this.currentTetromino,this.currentTetromino.x,e)){this.board.placeTetromino(this.currentTetromino);const e=this.board.clearLines();e>0&&this.onLineClearCallback&&this.onLineClearCallback(e),this.score+=this.getScoreForLines(e),this.checkLevelUp(),this.spawnTetromino()}else this.currentTetromino.move(0,1)}}getScoreForLines(e){switch(e){case 1:return 100;case 2:return 300;case 3:return 500;case 4:return 800;default:return 0}}checkLevelUp(){const e=Math.floor(this.score/1e3)+1;e>this.level&&(this.level=e,this.onLevelUpCallback&&this.onLevelUpCallback(this.level))}getLevel(){return this.level}getDropSpeed(){return Math.max(50,500-50*(this.level-1))}spawnTetromino(){this.currentTetromino=this.nextTetrominos.shift()||null,this.nextTetrominos.push(this.generateRandomTetromino()),this.currentTetromino&&this.board.checkCollision(this.currentTetromino,this.currentTetromino.x,this.currentTetromino.y)&&(this.gameOver=!0),this.canHold=!0}generateRandomTetromino(){const e=i[Math.floor(Math.random()*i.length)];return new o(Math.floor(this.board.width/2)-2,0,e,this.currentSkin)}handleInput(e){if(this.gameOver||!this.currentTetromino)return;let t=this.currentTetromino.x,i=this.currentTetromino.y;switch(e){case"ArrowLeft":t--;break;case"ArrowRight":t++;break;case"ArrowDown":i++;break;case"ArrowUp":const e=this.currentTetromino.getShape();this.currentTetromino.rotate(),this.board.checkCollision(this.currentTetromino,t,i)&&this.currentTetromino.setShape(e);break;case"c":if(this.canHold){if(this.holdTetromino){const e=this.currentTetromino;this.currentTetromino=this.holdTetromino,this.holdTetromino=e,this.currentTetromino.x=Math.floor(this.board.width/2)-2,this.currentTetromino.y=0}else this.holdTetromino=this.currentTetromino,this.spawnTetromino();this.canHold=!1}}this.board.checkCollision(this.currentTetromino,t,i)||this.currentTetromino.move(t-this.currentTetromino.x,i-this.currentTetromino.y)}isGameOver(){return this.gameOver&&this.score>this.highScore&&(this.highScore=this.score,h.saveItem(t,this.highScore.toString())),this.gameOver}getScore(){return this.score}getHighScore(){return this.highScore}getGhostTetrominoPosition(){if(!this.currentTetromino)return null;let e=this.currentTetromino.y;for(;!this.board.checkCollision(this.currentTetromino,this.currentTetromino.x,e+1);)e++;return{x:this.currentTetromino.x,y:e}}hardDrop(){if(this.gameOver||!this.currentTetromino)return;const e=this.currentTetromino.y,t=this.getGhostTetrominoPosition();if(t){this.currentTetromino.y=t.y;const i=this.currentTetromino.y-e;this.score+=2*i,this.board.placeTetromino(this.currentTetromino);const r=this.board.clearLines();this.score+=this.getScoreForLines(r),this.checkLevelUp(),this.spawnTetromino()}}}(10,20,e=>{const t=[];for(let i=0;i<e;i++)t.push(19-i);l.triggerLineClearAnimation(t)},e=>{l.triggerLevelUpAnimation()}),l=new class{constructor(e,t,i,r){this.lineClearAnimationStartTime=null,this.lineClearAnimationLines=[],this.levelUpAnimationStartTime=null,this.backgroundImage=null,this.gameCanvas=document.getElementById(e),this.gameCtx=this.gameCanvas.getContext("2d"),this.nextCanvas=document.getElementById(t),this.nextCtx=this.nextCanvas.getContext("2d"),this.holdCanvas=document.getElementById(i),this.holdCtx=this.holdCanvas.getContext("2d"),this.cellSize=r}setBackgroundImage(e){e?(this.backgroundImage=new Image,this.backgroundImage.src=e,this.backgroundImage.onload=()=>{}):this.backgroundImage=null}drawBackground(){this.backgroundImage&&this.gameCtx.drawImage(this.backgroundImage,0,0,this.gameCanvas.width,this.gameCanvas.height)}drawBoard(e){const t=performance.now();for(let i=0;i<e.height;i++)for(let r=0;r<e.width;r++)if(null!==this.lineClearAnimationStartTime&&this.lineClearAnimationLines.includes(i)){const n=t-this.lineClearAnimationStartTime;n<200?Math.floor(n/50)%2==0?(this.gameCtx.fillStyle="white",this.gameCtx.fillRect(r*this.cellSize,i*this.cellSize,this.cellSize,this.cellSize)):null!==e.grid[i][r]?(this.gameCtx.fillStyle=e.grid[i][r],this.gameCtx.fillRect(r*this.cellSize,i*this.cellSize,this.cellSize,this.cellSize)):this.gameCtx.clearRect(r*this.cellSize,i*this.cellSize,this.cellSize,this.cellSize):(this.lineClearAnimationStartTime=null,this.lineClearAnimationLines=[])}else null!==e.grid[i][r]?(this.gameCtx.fillStyle=e.grid[i][r],this.gameCtx.fillRect(r*this.cellSize,i*this.cellSize,this.cellSize,this.cellSize)):this.gameCtx.clearRect(r*this.cellSize,i*this.cellSize,this.cellSize,this.cellSize)}drawBlock(e,t,i,r){e.fillStyle=r,e.fillRect(t*this.cellSize,i*this.cellSize,this.cellSize,this.cellSize)}drawTetromino(e){const t=e.getShape(),i=e.getSkinColor();for(let r=0;r<t.length;r++)for(let n=0;n<t[r].length;n++)0!==t[r][n]&&this.drawBlock(this.gameCtx,e.x+n,e.y+r,i)}clearGameCanvas(){this.gameCtx.clearRect(0,0,this.gameCanvas.width,this.gameCanvas.height),this.drawBackground()}clearNextCanvas(){this.nextCtx.clearRect(0,0,this.nextCanvas.width,this.nextCanvas.height)}clearHoldCanvas(){this.holdCtx.clearRect(0,0,this.holdCanvas.width,this.holdCanvas.height)}drawGameOver(){this.gameCtx.fillStyle="rgba(0, 0, 0, 0.7)",this.gameCtx.fillRect(0,this.gameCanvas.height/2-30,this.gameCanvas.width,60),this.gameCtx.fillStyle="white",this.gameCtx.font="30px Arial",this.gameCtx.textAlign="center",this.gameCtx.fillText("Game Over",this.gameCanvas.width/2,this.gameCanvas.height/2+10)}drawNextTetrominos(e){this.clearNextCanvas();let t=0;for(const i of e){const e=i.getShape(),r=i.getSkinColor();for(let i=0;i<e.length;i++)for(let n=0;n<e[i].length;n++)0!==e[i][n]&&this.drawBlock(this.nextCtx,n,t+i,r);t+=e.length+1}}drawHoldTetromino(e){this.clearHoldCanvas();const t=e.getShape(),i=e.getSkinColor();for(let e=0;e<t.length;e++)for(let r=0;r<t[e].length;r++)0!==t[e][r]&&this.drawBlock(this.holdCtx,r,e,i)}drawGhostTetromino(e,t){const i=e.getShape();for(let r=0;r<i.length;r++)for(let n=0;n<i[r].length;n++)0!==i[r][n]&&this.drawBlock(this.gameCtx,e.x+n,t+r,"rgba(255, 255, 255, 0.3)")}triggerLineClearAnimation(e){this.lineClearAnimationLines=e,this.lineClearAnimationStartTime=performance.now()}triggerLevelUpAnimation(){this.levelUpAnimationStartTime=performance.now()}drawLevelUpAnimation(){if(null===this.levelUpAnimationStartTime)return;const e=performance.now()-this.levelUpAnimationStartTime;e<1e3?(this.gameCtx.save(),this.gameCtx.fillStyle=`rgba(255, 255, 255, ${.5*(1-e/1e3)})`,this.gameCtx.fillRect(0,0,this.gameCanvas.width,this.gameCanvas.height),this.gameCtx.fillStyle="white",this.gameCtx.font="bold 60px Arial",this.gameCtx.textAlign="center",this.gameCtx.textBaseline="middle",this.gameCtx.fillText("LEVEL UP!",this.gameCanvas.width/2,this.gameCanvas.height/2),this.gameCtx.restore()):this.levelUpAnimationStartTime=null}}("tetrisCanvas","nextCanvas","holdCanvas",20),c=new class{constructor(e,t){this.scoreElement=document.getElementById("score"),this.highScoreElement=document.getElementById("highScore"),this.levelElement=document.getElementById("level"),this.startButton=document.getElementById("startButton"),this.gameOverElement=document.getElementById("gameOver"),this.backgroundImageInput=document.getElementById("backgroundImageInput"),this.backgroundPreview=document.getElementById("backgroundPreview"),this.tetrominoSkinSelect=document.getElementById("tetrominoSkinSelect"),this.renderer=t,this.mainMenuElement=document.getElementById("mainMenu"),this.startButton.addEventListener("click",()=>{e.start(),this.hideGameOver(),this.hideMainMenu()}),this.backgroundImageInput.addEventListener("change",e=>{const t=e.target.files?.[0];if(t){const e=new FileReader;e.onload=e=>{const t=e.target?.result;this.backgroundPreview.src=t,this.backgroundPreview.style.display="block",this.renderer.setBackgroundImage(t)},e.readAsDataURL(t)}else this.backgroundPreview.src="",this.backgroundPreview.style.display="none",this.renderer.setBackgroundImage(null)}),this.tetrominoSkinSelect.addEventListener("change",t=>{const i=t.target.value;e.setTetrominoSkin(i)})}updateScore(e){this.scoreElement.innerText=`Score: ${e}`}updateHighScore(e){this.highScoreElement.innerText=`High Score: ${e}`}updateLevel(e){this.levelElement.innerText=`Level: ${e}`}showGameOver(){this.gameOverElement.style.display="block"}hideGameOver(){this.gameOverElement.style.display="none"}showStartButton(){}showMainMenu(){this.mainMenuElement.style.display="flex",document.getElementById("game-container").style.display="none"}hideMainMenu(){this.mainMenuElement.style.display="none",document.getElementById("game-container").style.display="flex"}}(a,l);let m=0;function g(e){if(a.isGameOver())return c.showGameOver(),void c.showMainMenu();if(m||(m=e),e-m>a.getDropSpeed()&&(a.update(),m=e),l.clearGameCanvas(),l.drawBoard(a.board),a.currentTetromino){const e=a.getGhostTetrominoPosition();e&&l.drawGhostTetromino(a.currentTetromino,e.y),l.drawTetromino(a.currentTetromino)}a.nextTetrominos.length>0&&l.drawNextTetrominos(a.nextTetrominos),a.holdTetromino&&l.drawHoldTetromino(a.holdTetromino),c.updateScore(a.getScore()),c.updateHighScore(a.getHighScore()),c.updateLevel(a.getLevel()),l.drawLevelUpAnimation(),requestAnimationFrame(g)}document.addEventListener("keydown",e=>{a.isGameOver()&&"r"===e.key?(a.start(),c.hideGameOver(),c.hideMainMenu(),g(0)):" "===e.key?a.hardDrop():a.handleInput(e.key)}),c.showMainMenu()})();