(()=>{"use strict";class t{constructor(t,e){this.width=t,this.height=e,this.grid=Array(e).fill(null).map(()=>Array(t).fill(null))}checkCollision(t,e,r){const i=t.getShape();for(let t=0;t<i.length;t++)for(let o=0;o<i[t].length;o++)if(0!==i[t][o]){const i=e+o,s=r+t;if(i<0||i>=this.width||s>=this.height)return!0;if(s>=0&&null!==this.grid[s][i])return!0}return!1}placeTetromino(t){const e=t.getShape();for(let r=0;r<e.length;r++)for(let i=0;i<e[r].length;i++)0!==e[r][i]&&(this.grid[t.y+r][t.x+i]=t.getColor())}clear(){this.grid=Array(this.height).fill(null).map(()=>Array(this.width).fill(null))}clearLines(){let t=0;for(let e=this.height-1;e>=0;e--)this.grid[e].every(t=>null!==t)&&(this.grid.splice(e,1),this.grid.unshift(Array(this.width).fill(null)),t++,e++);return t}}class e{constructor(t,e,r){this.x=t,this.y=e,this.type=r,this.shape=this.getInitialShape(r),this.color=this.getColorForType(r)}getInitialShape(t){switch(t){case"I":return[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]];case"J":return[[1,0,0],[1,1,1],[0,0,0]];case"L":return[[0,0,1],[1,1,1],[0,0,0]];case"O":return[[1,1],[1,1]];case"S":return[[0,1,1],[1,1,0],[0,0,0]];case"T":return[[0,1,0],[1,1,1],[0,0,0]];case"Z":return[[1,1,0],[0,1,1],[0,0,0]];default:return[]}}getColorForType(t){switch(t){case"I":return"cyan";case"J":return"blue";case"L":return"orange";case"O":return"yellow";case"S":return"lime";case"T":return"purple";case"Z":return"red";default:return"gray"}}getColor(){return this.color}move(t,e){this.x+=t,this.y+=e}rotate(){for(let t=0;t<this.shape.length;t++)for(let e=0;e<t;e++)[this.shape[t][e],this.shape[e][t]]=[this.shape[e][t],this.shape[t][e]];this.shape.forEach(t=>t.reverse())}getShape(){return this.shape}setShape(t){this.shape=t}getType(){return this.type}}class r{static saveItem(t,e){try{localStorage.setItem(t,e)}catch(t){console.error("Error saving to localStorage",t)}}static loadItem(t){try{return localStorage.getItem(t)}catch(t){return console.error("Error loading from localStorage",t),null}}static clearItem(t){try{localStorage.removeItem(t)}catch(t){console.error("Error clearing from localStorage",t)}}}const i=new class{constructor(e,r){this.currentTetromino=null,this.nextTetrominos=[],this.holdTetromino=null,this.canHold=!0,this.score=0,this.highScore=0,this.level=1,this.gameOver=!1,this.tetrominoTypes=["I","J","L","O","S","T","Z"],this.board=new t(e,r)}start(){this.gameOver=!1,this.score=0,this.level=1,this.highScore=parseInt(r.loadItem("highScore")||"0"),this.board.clear(),this.holdTetromino=null,this.canHold=!0,this.nextTetrominos=[];for(let t=0;t<3;t++)this.nextTetrominos.push(this.generateRandomTetromino());this.spawnTetromino()}update(){if(!this.gameOver&&this.currentTetromino){const t=this.currentTetromino.y+1;if(this.board.checkCollision(this.currentTetromino,this.currentTetromino.x,t)){this.board.placeTetromino(this.currentTetromino);const t=this.board.clearLines();this.score+=this.getScoreForLines(t),this.checkLevelUp(),this.spawnTetromino()}else this.currentTetromino.move(0,1)}}getScoreForLines(t){switch(t){case 1:return 100;case 2:return 300;case 3:return 500;case 4:return 800;default:return 0}}checkLevelUp(){const t=Math.floor(this.score/1e3)+1;t>this.level&&(this.level=t)}getLevel(){return this.level}getDropSpeed(){return Math.max(50,500-50*(this.level-1))}spawnTetromino(){this.currentTetromino=this.nextTetrominos.shift()||null,this.nextTetrominos.push(this.generateRandomTetromino()),this.currentTetromino&&this.board.checkCollision(this.currentTetromino,this.currentTetromino.x,this.currentTetromino.y)&&(this.gameOver=!0),this.canHold=!0}generateRandomTetromino(){const t=this.tetrominoTypes[Math.floor(Math.random()*this.tetrominoTypes.length)];return new e(Math.floor(this.board.width/2)-2,0,t)}handleInput(t){if(this.gameOver||!this.currentTetromino)return;let e=this.currentTetromino.x,r=this.currentTetromino.y;switch(t){case"ArrowLeft":e--;break;case"ArrowRight":e++;break;case"ArrowDown":r++;break;case"ArrowUp":const t=this.currentTetromino.getShape();this.currentTetromino.rotate(),this.board.checkCollision(this.currentTetromino,e,r)&&this.currentTetromino.setShape(t);break;case"c":if(this.canHold){if(this.holdTetromino){const t=this.currentTetromino;this.currentTetromino=this.holdTetromino,this.holdTetromino=t,this.currentTetromino.x=Math.floor(this.board.width/2)-2,this.currentTetromino.y=0}else this.holdTetromino=this.currentTetromino,this.spawnTetromino();this.canHold=!1}}this.board.checkCollision(this.currentTetromino,e,r)||this.currentTetromino.move(e-this.currentTetromino.x,r-this.currentTetromino.y)}isGameOver(){return this.gameOver&&this.score>this.highScore&&(this.highScore=this.score,r.saveItem("highScore",this.highScore.toString())),this.gameOver}getScore(){return this.score}getHighScore(){return this.highScore}getGhostTetrominoPosition(){if(!this.currentTetromino)return null;let t=this.currentTetromino.y;for(;!this.board.checkCollision(this.currentTetromino,this.currentTetromino.x,t+1);)t++;return{x:this.currentTetromino.x,y:t}}hardDrop(){if(this.gameOver||!this.currentTetromino)return;const t=this.currentTetromino.y,e=this.getGhostTetrominoPosition();if(e){this.currentTetromino.y=e.y;const r=this.currentTetromino.y-t;this.score+=2*r,this.board.placeTetromino(this.currentTetromino);const i=this.board.clearLines();this.score+=this.getScoreForLines(i),this.checkLevelUp(),this.spawnTetromino()}}}(10,20),o=new class{constructor(t,e,r,i){this.gameCanvas=document.getElementById(t),this.gameCtx=this.gameCanvas.getContext("2d"),this.nextCanvas=document.getElementById(e),this.nextCtx=this.nextCanvas.getContext("2d"),this.holdCanvas=document.getElementById(r),this.holdCtx=this.holdCanvas.getContext("2d"),this.cellSize=i}drawBoard(t){for(let e=0;e<t.height;e++)for(let r=0;r<t.width;r++)null!==t.grid[e][r]&&(this.gameCtx.fillStyle=t.grid[e][r],this.gameCtx.fillRect(r*this.cellSize,e*this.cellSize,this.cellSize,this.cellSize))}drawTetromino(t){const e=t.getShape(),r=t.getColor();this.gameCtx.fillStyle=r;for(let r=0;r<e.length;r++)for(let i=0;i<e[r].length;i++)0!==e[r][i]&&this.gameCtx.fillRect((t.x+i)*this.cellSize,(t.y+r)*this.cellSize,this.cellSize,this.cellSize)}clearGameCanvas(){this.gameCtx.clearRect(0,0,this.gameCanvas.width,this.gameCanvas.height)}clearNextCanvas(){this.nextCtx.clearRect(0,0,this.nextCanvas.width,this.nextCanvas.height)}clearHoldCanvas(){this.holdCtx.clearRect(0,0,this.holdCanvas.width,this.holdCanvas.height)}drawGameOver(){this.gameCtx.fillStyle="rgba(0, 0, 0, 0.7)",this.gameCtx.fillRect(0,this.gameCanvas.height/2-30,this.gameCanvas.width,60),this.gameCtx.fillStyle="white",this.gameCtx.font="30px Arial",this.gameCtx.textAlign="center",this.gameCtx.fillText("Game Over",this.gameCanvas.width/2,this.gameCanvas.height/2+10)}drawNextTetrominos(t){this.clearNextCanvas();let e=0;for(const r of t){const t=r.getShape(),i=r.getColor();this.nextCtx.fillStyle=i;for(let r=0;r<t.length;r++)for(let i=0;i<t[r].length;i++)0!==t[r][i]&&this.nextCtx.fillRect(i*this.cellSize,(e+r)*this.cellSize,this.cellSize,this.cellSize);e+=t.length+1}}drawHoldTetromino(t){this.clearHoldCanvas();const e=t.getShape(),r=t.getColor();this.holdCtx.fillStyle=r;for(let t=0;t<e.length;t++)for(let r=0;r<e[t].length;r++)0!==e[t][r]&&this.holdCtx.fillRect(r*this.cellSize,t*this.cellSize,this.cellSize,this.cellSize)}drawScore(t){}drawHighScore(t){}drawLevel(t){}drawGhostTetromino(t,e){const r=t.getShape();this.gameCtx.fillStyle="rgba(255, 255, 255, 0.3)";for(let i=0;i<r.length;i++)for(let o=0;o<r[i].length;o++)0!==r[i][o]&&this.gameCtx.fillRect((t.x+o)*this.cellSize,(e+i)*this.cellSize,this.cellSize,this.cellSize)}}("tetrisCanvas","nextCanvas","holdCanvas",20),s=new class{constructor(t){this.scoreElement=document.getElementById("score"),this.highScoreElement=document.getElementById("highScore"),this.levelElement=document.getElementById("level"),this.startButton=document.getElementById("startButton"),this.gameOverElement=document.getElementById("gameOver"),this.startButton.addEventListener("click",()=>{t.start(),this.hideGameOver(),this.startButton.style.display="none"})}updateScore(t){this.scoreElement.innerText=`Score: ${t}`}updateHighScore(t){this.highScoreElement.innerText=`High Score: ${t}`}updateLevel(t){this.levelElement.innerText=`Level: ${t}`}showGameOver(){this.gameOverElement.style.display="block"}hideGameOver(){this.gameOverElement.style.display="none"}showStartButton(){this.startButton.style.display="block"}}(i);let h=0;function n(t){if(i.isGameOver())return s.showGameOver(),void s.showStartButton();if(h||(h=t),t-h>i.getDropSpeed()&&(i.update(),h=t),o.clearGameCanvas(),o.drawBoard(i.board),i.currentTetromino){const t=i.getGhostTetrominoPosition();t&&o.drawGhostTetromino(i.currentTetromino,t.y),o.drawTetromino(i.currentTetromino)}i.nextTetrominos.length>0&&o.drawNextTetrominos(i.nextTetrominos),i.holdTetromino&&o.drawHoldTetromino(i.holdTetromino),s.updateScore(i.getScore()),s.updateHighScore(i.getHighScore()),s.updateLevel(i.getLevel()),requestAnimationFrame(n)}document.addEventListener("keydown",t=>{i.isGameOver()&&"r"===t.key?(i.start(),s.hideGameOver(),s.showStartButton(),n(0)):" "===t.key?i.hardDrop():i.handleInput(t.key)}),s.showStartButton()})();